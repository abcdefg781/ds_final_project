---
title: "Taxi Zones"
author: "Adeline Shin"
date: "11/22/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# install.packages("sf")
# install.packages("tmap")
# install.packages("ggmap")

library(tidyverse)
library(leaflet)
library(viridis)
library(sf)
library(tmap)
library(plotly)
```

# Loading in Taxi Zone Codes
```{r}
taxi_zones = read.csv("./data/taxi_zones.csv")
```

# Mapping Lat/Long
```{r}
pal = colorFactor(
  palette = magma,
  domain = taxi_zones$borough
)

taxi_zones %>% 
  leaflet() %>% 
  addTiles() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(
    ~x, ~y,
    color = ~pal(borough),
    radius = 1
  )
  
```

# Mapping Dropoffs in Manhattan on Feb 14
```{r}
zone_map_data = read_sf("./data/taxi_zones.shp")

taxi_data = 
  read.csv("./data/transport_final.csv") 

do_neighborhood_count = as.data.frame(table(taxi_data$do_neiborhood)) %>% 
  select(zone = Var1, freq = Freq)

zone_maps_plot = left_join(zone_map_data, do_neighborhood_count, by = "zone") %>% 
  na.omit() %>% 
  filter(borough == "Manhattan")

tmap_mode("plot")

zone_map =
  tm_shape(zone_maps_plot) +
  tm_polygons(
    "freq",
    style = "quantile",
    ) +
  tm_layout(title = "Dropoffs in Manhattan on Feb 14", title.size = 0.6, legend.text.size = 0.5, frame = FALSE)

zone_map + tm_basemap(server = "OpenTopoMap")

```

# Doing the same for just Valentine's Day dinner
```{r}
vday_dinner_data =
  taxi_data %>% 
  separate(pickup_time, into = c("pickup_hr", "pickup_min", "pickup_sec"), sep = ":") %>% 
  separate(dropoff_time, into = c("dropoff_hr", "dropoff_min", "dropoff_sec"), sep = ":") %>% 
  select(-pickup_sec, -pickup_min, -dropoff_sec, -pickup_sec) %>% 
  mutate(
    pickup_hr = as.numeric(pickup_hr),
    dropoff_hr = as.numeric(dropoff_hr)
  ) %>% 
  filter(dropoff_hr == 18 | dropoff_hr == 19 | dropoff_hr == 20)

vday_do_neighborhood_count = as.data.frame(table(vday_dinner_data$do_neiborhood)) %>% 
  select(zone = Var1, freq = Freq)

vday_zone_maps_plot = left_join(zone_map_data, vday_do_neighborhood_count, by = "zone") %>% 
  na.omit() %>% 
  filter(borough == "Manhattan")

zone_map =
  tm_shape(vday_zone_maps_plot) +
  tm_polygons(
    "freq",
    style = "quantile",
    ) +
  tm_layout(title = "Valentine's Dinner Dropoffs in Manhattan", title.size = 0.6, legend.text.size = 0.5, frame = FALSE)

zone_map + tm_basemap(server = "OpenTopoMap")
```


# Trying to convert coordinates here (a mess)
```{r}
library(rgdal)
zone_coords =
  zone_map_data[[7]]

coords = 
  as.data.frame(zone_coords[[1]][[1]][[1]]) %>% 
  select(lon = V1, lat = V2)

coords = SpatialPoints (coords, proj4string = CRS ('+proj=utm +zone=18 +ellps=GRS80 +datum=NAD83 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs'))

coord_WGS84 <- spTransform(coords, CRS('+proj=longlat +datum=WGS84 +no_defs'))

# coordinates(coords) = c("lon", "lat")
# proj4string(coords) = CRS("+init=epsg:4326")
```

```{r}
zone_map_data %>% 
  leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) 
```

